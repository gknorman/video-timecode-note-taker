<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style type="text/css">
		table, th, td {
		  border: 1px solid black;
		  border-collapse: collapse;
		}
		th {
		  padding: 5px 15px 5px 15px;
		}
		th {
		  text-align: left;
		}
	</style>


</head>
<body>
	<label id="timer">Timecode: 00:00:00</label>
	<p></p>
	<div id="currentFPS">Current FPS: </div>
	<!-- <label for="fps">Change FPS: </label> -->
		<input type="number" name="fps" id="fps" placeholder="Enter new framerate">
		<button onclick="changeFPS(document.getElementById('fps').value)"> UPDATE FPS </button>
	<p></p>
	<label for="comments">Comments:</label>
<!-- 	<form> -->
		<input type="text" id="comments" name="comments"><br />
		
		<input type="submit" value="Submit" id="submit" onclick="newLap(document.getElementById('comments').value)">
<!-- 	</form> -->
	<p></p>
	<button onclick="start()" id="startbtn"> START </button>
	<button onclick="newLap()" id="newLap"> LAP </button>
	<button onclick="reset()" id="resetbtn"> RESET </button>
	<button href="" onclick="download()" id="downloadButton" class="downloadButton" download="data.txt"> SAVE DATA</button>
	<p></p>
	<section id="lapssection">
		<table id="lapTable" class="lapTable">
			<tr id="lapHeader">
				<th>#</th>
				<th>Timecode</th>
				<th>Note</th>
			</tr>
		</table>
	</section>

	<script type="text/javascript">

		let notesData = [];

		let m, s, ms, lapCount, started, interval;
		let fps, milli_to_FPS
		let totalRunningTime;

		const comments = document.getElementById("comments");

		comments.addEventListener("keyup", function(event) {
			if (event.keyCode === 13) {
				event.preventDefault();
				document.getElementById("submit").click();
			}
		});


		const startbtn = document.getElementById("startbtn");
		const resetbtn = document.getElementById("resetbtn");

		const lapbtn = document.getElementById("newLap");
		const lapssect = document.getElementById("lapssection");
		const lapTable = document.getElementById("lapTable");
		const fpsBtn = document.getElementById("currentFPS");
		fpsBtn.innerHTML = "Current FPS: " + String(fps);
	    
	    // var milli_to_FPS = (1000/fps).toFixed(2);


		document.addEventListener('DOMContentLoaded', () => {
		  const ref = localStorage.getItem('notesItemsRef');
		  if (ref) {
		    tableData = JSON.parse(ref);
		    notesData = tableData;
		   	renderNotes(tableData);
		   	timerData = tableData[tableData.length - 1];
		   	m = timerData.m;
		   	s = timerData.s;
		   	ms = timerData.ms;
		   	totalRunningTime = timerData.totalRunningTime;
		   	fps = timerData.fps;
		   	milli_to_FPS = timerData.milli_to_FPS;
		   	fpsBtn.innerHTML = "Current FPS: " + String(fps);
		   	lapCount = tableData.length + 1
	    	timecode = timerData.timecode;
	    	document.getElementById("timer").innerHTML="Timecode: "+String(m).padStart(2,'0')+":"+String(s).padStart(2,'0')+":"+String(Math.floor(ms/milli_to_FPS)).padStart(2,'0');
	    	clearInterval(interval);
	        document.getElementById("startbtn").innerHTML=" RESUME ";
	        started = false;
		  } else {
		  	resetNotes();
		  }
		});


		// Need to link reset() to here
		function resetNotes() {
			console.log("resetting notes");
			m = 0;
			s = 0;
			ms = 0;
			lapCount = 1;
			started = false;
			fps = 29.97;
			totalRunningTime = 0;
			milli_to_FPS = (1000/fps).toFixed(2);
			fpsBtn.innerHTML = "Current FPS: " + String(fps);
			document.getElementById("timer").innerHTML="Timecode: 00:00:00";
			document.getElementById("startbtn").innerHTML=" START ";
		}

		function reset(){
	        let lapsarr=document.getElementById("lapTable").getElementsByClassName("lap");
	        let l=lapsarr.length;
	        // var ps=lapssect.getElementsByTagName("p");
	        for(i=0; i<l; i+=1){
	            lapTable.removeChild(lapsarr[0]);
	        }
	        notesData = [];
	        localStorage.removeItem('notesItemsRef');

	        clearInterval(interval);
	        resetNotes();
	        
	        // document.getElementById("timer").innerHTML="Timecode: 00:00:00";
    }


		function changeFPS(newFPS="") {
	    	if (newFPS) {
	    		fps = newFPS;
	    		fpsBtn.innerHTML = "Current FPS: " + String(fps);
	    		milli_to_FPS = (1000/fps).toFixed(2);
	    	} else {
	    		fps = 29.97;
	    		fpsBtn.innerHTML = "Current FPS: " + String(fps);
	    		milli_to_FPS = (1000/fps).toFixed(2);
	    	}
	    	fpsBtn.innerHTML = "Current FPS: " + String(fps);
	    	localStorage.setItem('savedFPS',fps);
	    	if (notesData.length > 0) {
	    		replaceTimecode();
	    	}
	    }

	    function replaceTimecode() {
	    	let lapsarr=document.getElementById("lapTable").getElementsByClassName("lap");
	        let l=lapsarr.length;
	        // var ps=lapssect.getElementsByTagName("p");
			// const fullTable = document.querySelector('lapTable');
	        for(i=0; i<l; i+=1){
	        	rowData = notesData[i];

	        	let timecodeNew = String(rowData.m).padStart(2,'0')+":"+String(rowData.s).padStart(2,'0')+":"+String(Math.floor(rowData.ms/milli_to_FPS)).padStart(2,'0');
	            const rowItem = document.querySelector(`[data_key='${rowData.data_key}']`);
	            if (rowItem) {
    				rowItem.cells[1].innerHTML = timecodeNew;
    			}
	        }
	    }

		function renderNotes(data=notesData) {
			const savedFPS = localStorage.getItem('savedFPS');
			if (savedFPS) {
				fps = savedFPS;
			} else {
				fps = 29.97;
			}

			fpsBtn.innerHTML = "Current FPS: " + String(fps);

			if (data.length > 0) {
				data.forEach(t => {
				renderRow(t);
				// notesData.push(rowData);
		      	console.log("content loaded:",t);
		    	})
			} else {
				resetNotes();
			}

		    // localStorage.setItem('notesItemsRef', JSON.stringify(tableData));
		};

		function renderRow(rowData) {
			
    		const rowItem = document.querySelector(`[data_key='${rowData.data_key}']`);
			const fullTable = document.querySelector('#lapTable');

			let lapRow = document.createElement("tr");
    		lapRow.setAttribute("class","lap");
    		lapRow.setAttribute('data_key', rowData.data_key);
    		lapRow.setAttribute('noteTime', rowData.totalRunningTime);

    		let lapNum = document.createElement("td");
    		lapNum.setAttribute("class","num");
    		lapNum.innerHTML = rowData.lapCount;

    		let lapLabel = document.createElement("td");
    		lapLabel.setAttribute("class","lapText");
    		let lapLblTxt = document.createTextNode(rowData.timecode);
    		lapLabel.appendChild(lapLblTxt);

    		let lapComment = document.createElement("td");
    		lapComment.setAttribute("class","lapComment");
    		lapComment.innerHTML = rowData.userComment;

    		let deleteColumn = document.createElement("td");
    		deleteColumn.setAttribute("class","deleteColumn");

    		let deleteButton = document.createElement("input");
    		deleteButton.setAttribute("class","delete-button");
    		deleteButton.setAttribute("type","button");
    		deleteButton.setAttribute("value","Delete");
    		deleteButton.setAttribute("onclick","deleteNote(this)")

    		deleteColumn.appendChild(deleteButton);

    		lapRow.appendChild(lapNum);
    		lapRow.appendChild(lapLabel);
    		lapRow.appendChild(lapComment);
    		lapRow.appendChild(deleteColumn);

			if (rowItem) {
    			fullTable.replaceChild(lapRow, rowItem);
    		} else {
    			lapTable.appendChild(lapRow);
    		}
		};

		function timer() {

        	document.getElementById("timer").innerHTML="Timecode: "+String(m).padStart(2,'0')+":"+String(s).padStart(2,'0')+":"+String(Math.floor(ms/milli_to_FPS)).padStart(2,'0');
        	totalRunningTime+=10;
        	ms+= 10;
        	if(ms === 1000){
	            s+=1;
	            ms=0;
	        }
	        
	        if(s==60){
	            m+=1;
	            s=0;
	        }
	    }

	    function start(){
	        if(started === false){
	            document.getElementById("startbtn").innerHTML=" PAUSE ";
	            interval=setInterval(timer,10);
	            started = true;
	        }
	        else{
	            clearInterval(interval);
	            document.getElementById("startbtn").innerHTML=" RESUME ";
	            started = false;
	        }
	    }

	    function newLap(userComment="") {
	    	// if(started === true) {
	    		let data_key = Date.now();
    			timecode = String(m).padStart(2,'0')+":"+String(s).padStart(2,'0')+":"+String(Math.floor(ms/milli_to_FPS)).padStart(2,'0');
	    		const rowData = {
	    			totalRunningTime,
	    			data_key,
	    			lapCount,
	    			timecode,
	    			userComment,
	    			m,
	    			s,
	    			ms,
	    			fps,
	    			milli_to_FPS
	    		};
	    		console.log(JSON.stringify(rowData));
	    		notesData.push(rowData);
	    		localStorage.setItem('notesItemsRef', JSON.stringify(notesData));

	    		renderRow(rowData);

	    		lapCount += 1;
	    	// }
	    }

	    // const tableOfNotes = document.querySelector('#lapTable');
	    // tableOfNotes.addEventListener('click', event => {
	    // 	if (event.target.classList.contains("#delete-button")) {
	    // 		const itemKey = event.target.parentElement.dataset.key;
	    // 		deleteNote(itemKey);
	    // 	}
	    // });

	    function deleteNote(key) {
	    	// const index = notesData.findIndex(item => item.data_key === Number(key));
	    	// const noteItem = {
	    	// 	deleted: true,
	    	// 	...notesData[index]
	    	// };

	    	var index = key.parentNode.parentNode.rowIndex;
	    	console.log(String(index));
	    	var keyToDelete = notesData[index-1].data_key
	    	console.log(keyToDelete);
	    	console.log("Deleting:" + notesData[index-1]);
	    	document.getElementById("lapTable").deleteRow(index);

	    	notesData = notesData.filter(item => item.data_key !== Number(keyToDelete));

	    	if (notesData.length < 1) {
	    		resetNotes();
	    		return;
	    	}

	    	for(var i = 0; i < notesData.length; i++){
	    		notesData[i].lapCount = i + 1
	    		console.log(notesData[i].lapCount)
	    	}

	    	// console.log(JSON.stringify(notesData))

	    	localStorage.setItem('notesItemsRef', JSON.stringify(notesData));


	    	lapCount = notesData.length + 1
	    	var lastRow = notesData[notesData.length - 1];
	    	totalRunningTime = lastRow.totalRunningTime;
	    	m = lastRow.m;
	    	s = lastRow.s;
	    	ms = lastRow.ms;
	    	fps = lastRow.fps;
	    	milli_to_FPS = lastRow.milli_to_FPS;
	    	timecode = lastRow.timecode;

	    	document.getElementById("timer").innerHTML="Timecode: "+String(m).padStart(2,'0')+":"+String(s).padStart(2,'0')+":"+String(Math.floor(ms/milli_to_FPS)).padStart(2,'0');

	    	// document.getElementById("lapTable").deleteRow(index);

	    	renderNotes(notesData);
	    }



	    // const notesTable = document.querySelector("#submit");

	    let downloadUrl = null;
	    let downloadBTN = document.querySelector(".downloadButton");
	    

	    function createText() {
	    	let downloadText = "";
	    	for(var i = 0; i < notesData.length; i++) {
	    		var currentComment = "";
	    		if (notesData[i].userComment.trim().length == 0) {
	    			currentComment = "NO NOTE"
	    		} else {
	    			currentComment = notesData[i].userComment.trim();
	    		}

	    		if (i==0) {
	    			downloadText += String(notesData[i].lapCount) + "\n" + String(notesData[i].timecode) + "\n" + String(currentComment);
	    		} else {
	    			downloadText += "\n\n" + String(notesData[i].lapCount) + "\n" + String(notesData[i].timecode) + "\n" + String(currentComment);
	    		}
	    	}
	    	return downloadText;
	    }

	    function download() {
	    	var a = document.createElement("a");
	    	document.body.appendChild(a);
	    	var curText = createText();
	    	let file = new Blob([curText],{type: "text/plain;charset=utf-8"});
	    	if (downloadUrl) {
	    		URL.revokeObjectURL(downloadUrl);
	    	};

	    	downloadUrl = URL.createObjectURL(file);
	    	// downloadBTN.setAttribute("href",downloadUrl);
	    	a.setAttribute("href",downloadUrl);
	    	a.setAttribute("target","_blank");
	    	a.setAttribute("rel", "noopener noreferrer");

	    	// a.href = downloadUrl;
	    	a.click();

	    	filenameID = "Timecode_Notes" + String(Date.now());

	    	saveBlob(file,filenameID)
	    	// causeDownload = window.URL.createObjectURL(file);
	    	// a.href = causeDownload;
	    	// a.click();
	    	// window.URL.revokeObjectURL(file);

	    }

	    // CREDIT for this function that causes the same file to be shown in the browser to be downloaded instead:
	    // Philip Stanislaus
	    // https://gist.github.com/philipstanislaus/c7de1f43b52531001412
	    var saveBlob = (function () {
		    var a = document.createElement("a");
		    document.body.appendChild(a);
		    a.style = "display: none";
		    return function (blob, fileName) {
		        var url = window.URL.createObjectURL(blob);
		        a.href = url;
		        a.download = fileName;
		        a.click();
		        window.URL.revokeObjectURL(url);
		    };
		}());





	</script>

</body>
</html>
